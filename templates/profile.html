<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studify - My Profile</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&family=Konkhmer+Sleokchher&family=Lao+Muang+Khong&display=swap" rel="stylesheet">
    <style>
        /* ---------------------------------------------------- */
        /* 1. Ø§Ù„ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (CSS) */
        /* ---------------------------------------------------- */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #abd1f4;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }
        .container {
            width: 100%;
            max-width: 1251px;
            min-height: 700px;
            background: #EBF6FF;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            padding-bottom: 2rem;
        }
        /* Header */
        header {
            height: 150px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            background: white;
            border-bottom: 1px solid #f3f4f6;
            width: 100%;
        }
        .logo-section { display: flex; align-items: center; }
        .logo-section img { width: 150px; margin-bottom: -30px; }
        .logo-section h1 {
            color: #10203a;
            font-family: 'Konkhmer Sleokchher', serif;
            font-size: 2.5rem;
            font-weight: 650;
            margin-left: -30px;
            margin-bottom: -30px;
        }
        nav { display: flex; gap: 3rem; align-items: center; margin-bottom: -30px; }
        nav a { text-decoration: none; color: #000; font-family: 'Konkhmer Sleokchher'; font-size: 1.4rem; }
        
        /* Main Layout */
        main { padding: 2rem; }
        .content-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 3rem; }
        
        /* Profile Section */
        .profile-section h2 { color: #0a2139; font-family: 'Konkhmer Sleokchher'; font-size: 2.8rem; margin-bottom: 2rem; }
        .profile-card { display: flex; gap: 1.5rem; }
        .avatar {
            width: 159px; height: 156px; border-radius: 50%;
            background: #ebf6ff; box-shadow: 0 4px 4px rgba(0,0,0,0.25);
            display: flex; align-items: center; justify-content: center; overflow: hidden;
        }
        .avatar img { width: 100%; height: 100%; object-fit: cover; }
        .profile-info h3 { color: #0a2139; font-family: 'Konkhmer Sleokchher'; font-size: 2.8rem; margin-bottom: 0.5rem; }
        .profile-info p { color: rgba(0,0,0,0.6); font-size: 1.2rem; }
        
        /* Edit Button */
        .btn-edit {
            background: #4a7fb8; color: white; font-family: 'Konkhmer Sleokchher';
            font-size: 1.25rem; padding: 0.6rem 2rem; border: none; border-radius: 20px;
            box-shadow: 0 4px 4px rgba(0,0,0,0.25); cursor: pointer; margin-top: 10px;
        }
        .edit-input {
            padding: 5px; border: 2px solid #4a7fb8; border-radius: 10px;
            font-size: 1.2rem; width: 100%; max-width: 300px; margin-bottom: 5px;
        }

        /* Hours Card */
        .hours-card { background: white; border-radius: 20px; box-shadow: 0 4px 4px rgba(0,0,0,0.25); padding: 2rem; }
        .hours-card h3, .hours-value { font-family: 'Konkhmer Sleokchher'; font-size: 2.2rem; margin-bottom: 1rem; }
        .progress-container { width: 100%; height: 15px; background: #e5e7eb; border-radius: 20px; overflow: hidden; margin-bottom: 1rem; }
        .progress-fill { height: 100%; width: 0%; background: #4cd4d0; border-radius: 20px; transition: width 0.5s; }
        .hours-text { color: rgba(0,0,0,0.37); font-size: 1.25rem; text-align: center; }

        /* Carousel & Cards (Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ù…Ù‡Ù… Ù„ØªØµØ­ÙŠØ­ Ø§Ù„Ù…ÙˆØ§Ø¯) */
        .bottom-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; }
        .progress-carousel { display: flex; align-items: center; gap: 1rem; width: 100%; }
        .carousel-scroll {
            display: flex; gap: 1rem; overflow-x: auto; scroll-behavior: smooth;
            width: 100%; padding: 10px 5px; scrollbar-width: none;
        }
        .carousel-scroll::-webkit-scrollbar { display: none; }
        .carousel-btn {
            width: 40px; height: 40px; border-radius: 50%; background: white;
            box-shadow: 0 4px 4px rgba(0,0,0,0.25); border: none; cursor: pointer; flex-shrink: 0;
        }

        /* ðŸŸ¢ ØªÙ†Ø³ÙŠÙ‚ ÙƒØ±ÙˆØª Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±) */
        .progress-card {
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            padding: 1rem;
            min-width: 160px;
            width: 160px;
            height: 230px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }
        .progress-card h4 {
            color: #10203a; font-family: 'Konkhmer Sleokchher'; font-size: 1.1rem;
            margin-bottom: 1rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; width: 100%;
        }
        .circle-container {
            position: relative; width: 100px; height: 100px; margin-bottom: 15px;
            display: flex; align-items: center; justify-content: center;
        }
        svg { transform: rotate(-90deg); width: 100px; height: 100px; }
        .progress-bg { fill: none; stroke: #f0f0f0; stroke-width: 8; }
        .progress-bar-circle {
            fill: none; stroke: #4cd4d0; stroke-width: 8; stroke-linecap: round;
            transition: stroke-dashoffset 1s ease-in-out;
        }
        .progress-text { font-family: 'Inter'; font-size: 0.9rem; color: #888; font-weight: bold; }

        /* Reward Card */
        .reward-card {
            background: white; border-radius: 20px; box-shadow: 0 4px 4px rgba(0,0,0,0.25);
            padding: 2rem; display: flex; align-items: center; gap: 1.5rem;
        }
        .reward-icon { width: 110px; height: 110px; }
        .reward-text h3 { font-family: 'Konkhmer Sleokchher'; font-size: 1.25rem; }
        .reward-text p { font-family: 'Konkhmer Sleokchher'; font-size: 2.2rem; }

        /* Responsive */
        @media (max-width: 1024px) {
            .content-grid, .bottom-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <img src="https://api.builder.io/api/v1/image/assets/TEMP/a972516383bf9672b4c04259e76273dcddd61507?width=328" alt="Studify logo">
                <h1>studify</h1>
            </div>
            <nav>
                <a href="/dashboard-page">Home</a> <a href="/friends-page">Friends</a> <a href="/auth/logout">Log out</a>
            </nav>
        </header>

        <main>
            <div class="content-grid">
                <div class="profile-section">
                    <h2>My Profile</h2>
                    <div class="profile-card">
                        <div class="avatar">
                            <img src="https://api.builder.io/api/v1/image/assets/TEMP/14b992f93b6150097c71e1c5dd691af6b6bee56e?width=318" alt="Avatar">
                        </div>
                        <div class="profile-info">
                            <h3 id="profileName">Loading...</h3>
                            <p id="profileEmail">...</p>
                            <button class="btn-edit" id="editBtn">Edit Profile</button>
                        </div>
                    </div>
                </div>

                <div class="hours-card">
                    <h3>Total Learning Hours</h3>
                    <p class="hours-value">0 Hours</p>
                    <div class="progress-container">
                        <div class="progress-fill"></div>
                    </div>
                    <p class="hours-text">Next Reward at 200 Hours</p>
                </div>
            </div>

            <div class="bottom-grid">
                <div class="progress-carousel">
                    <button class="carousel-btn" id="btnLeft">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 19l-7-7 7-7"/></svg>
                    </button>
                    <div class="carousel-scroll" id="carousel">
                        </div>
                    <button class="carousel-btn" id="btnRight">
                        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 5l7 7-7 7"/></svg>
                    </button>
                </div>

                <div class="reward-card">
                    <div class="reward-icon">
                        <svg viewBox="0 0 125 118" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M59.29 2.06C60.2 -0.69 64.09 -0.69 64.99 2.06L77.63 40.41H121.28C124.2 40.41 125.4 46.21 123.03 47.91L90.09 71.51L101.59 113.12C102.5 115.88 99.35 118.19 96.99 116.5L63.89 92.79L27.3 116.5C24.94 118.19 21.79 115.88 22.7 113.12L35.3 74.89L1.26 47.91C-1.11 46.21 0.09 42.47 3 42.47H46.66L59.29 2.06Z" fill="#F9C440"/>
                        </svg>
                    </div>
                    <div class="reward-text">
                        <h3>Reward Points Earned</h3>
                        <p id="pointsDisplay">0</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const BASE_API_URL = 'https://studify-dye7gqa7hfchgzdk.italynorth-01.azurewebsites.net';
        const PROFILE_API_URL = `${BASE_API_URL}/profile`;
        
        const profileNameElement = document.getElementById('profileName');
        const profileEmailElement = document.getElementById('profileEmail');
        const editBtn = document.getElementById('editBtn');
        const hoursValueElement = document.querySelector('.hours-value');
        const progressFillElement = document.querySelector('.progress-fill');
        const pointsDisplayElement = document.getElementById('pointsDisplay');
        const carousel = document.getElementById('carousel');
        
        let isEditing = false; 

        // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function fetchProfileData() {
            try {
                const response = await fetch(`${PROFILE_API_URL}/`); 
                if (response.status === 401) { window.location.href = '/index-page'; return; }
                
                const data = await response.json();
                console.log("âœ… Data received:", data);

                profileNameElement.innerText = data.username || 'N/A';
                profileEmailElement.innerText = data.email || 'N/A';
                pointsDisplayElement.innerText = data.points || 0;
                
                updateHoursDisplay(data.total_hours_studied || 0);
                
                // ðŸŸ¢ Ø±Ø³Ù… Ø§Ù„Ù…ÙˆØ§Ø¯ (Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±)
                renderProgressCards(data.subjects || []); 

            } catch (error) { console.error('Error:', error); }
        }

        // Ø¯Ø§Ù„Ø© Ø±Ø³Ù… Ø§Ù„Ø¯ÙˆØ§Ø¦Ø±
        function renderProgressCards(subjects) {
            carousel.innerHTML = ''; 
            if (!subjects || subjects.length === 0) {
                carousel.innerHTML = '<p style="text-align:center; width:100%; color:#888; margin-top:20px;">No subjects added.</p>';
                return;
            }

            subjects.forEach(subject => {
                const percent = Math.min(Math.max(subject.progress_percentage || 0, 0), 100);
                const radius = 40;
                const circumference = 2 * Math.PI * radius; 
                const offset = circumference - (percent / 100) * circumference;

                const card = document.createElement('div');
                card.className = 'progress-card';
                
                card.innerHTML = `
                    <h4>${subject.name}</h4>
                    <div class="circle-container">
                        <svg width="100" height="100">
                            <circle class="progress-bg" cx="50" cy="50" r="${radius}"></circle>
                            <circle class="progress-bar-circle" cx="50" cy="50" r="${radius}" 
                                    style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle>
                        </svg>
                        <div style="position:absolute; color:#4cd4d0; font-weight:bold;">
                            ${Math.round(percent)}%
                        </div>
                    </div>
                    <p class="progress-text">${Math.round(percent)}% Complete</p>
                `;
                carousel.appendChild(card);
            });
        }

        function updateHoursDisplay(totalHours) {
            const goalHours = 200;
            let progressPercentage = Math.min((totalHours / goalHours) * 100, 100);
            hoursValueElement.innerText = `${totalHours.toFixed(1)} Hours`;
            progressFillElement.style.width = `${progressPercentage}%`;
        }

        // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„
        editBtn.addEventListener('click', async function () {
            if (!isEditing) {
                const currentName = profileNameElement.innerText;
                profileNameElement.innerHTML = `<input type="text" class="edit-input" id="nameInput" value="${currentName}">`;
                profileEmailElement.style.display = 'none';
                const html = `<div id="tempEditFields" style="margin-bottom:10px;"><input type="password" class="edit-input" id="passwordInput" placeholder="New Password"><input type="password" class="edit-input" id="confirmPasswordInput" placeholder="Confirm Password"><div id="passwordError" style="color:red; font-size:0.8rem;"></div></div>`;
                editBtn.insertAdjacentHTML('beforebegin', html);
                editBtn.innerText = "Save Changes";
                isEditing = true;
            } else {
                const nameInput = document.getElementById('nameInput');
                const passwordInput = document.getElementById('passwordInput');
                const confirmInput = document.getElementById('confirmPasswordInput');
                
                if (passwordInput.value && passwordInput.value !== confirmInput.value) {
                    document.getElementById('passwordError').innerText = "Passwords mismatch"; return;
                }
                
                const updateData = { username: nameInput.value };
                if(passwordInput.value) updateData.password = passwordInput.value;

                try {
                    const res = await fetch(`${PROFILE_API_URL}/`, { method: 'PUT', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(updateData)});
                    if(res.ok) location.reload();
                } catch(e) { alert("Error"); }
            }
        });

        // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ÙƒØ§Ø±ÙˆØ³ÙŠÙ„
        document.getElementById('btnLeft').addEventListener('click', () => carousel.scrollBy({ left: -180, behavior: 'smooth' }));
        document.getElementById('btnRight').addEventListener('click', () => carousel.scrollBy({ left: 180, behavior: 'smooth' }));

        window.addEventListener('load', fetchProfileData);
    </script>
</body>
</html>
