<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studify - My Friends (Local Storage)</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Konkhmer+Sleokchher&family=KoHo:wght@400;500;600&family=Inter:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* نفس التنسيقات السابقة تماماً */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #abd1f4;
            min-height: 105vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1250px;
            min-height: 700px;
            background: #EBF6FF;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            position: relative;
        }

        header {
            height: 124px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 3rem;
            background: white;
            border-bottom: 1px solid #f3f4f6;
            margin: -2rem -2rem 2rem -2rem;
            width: calc(100% + 4rem);
            border-radius: 15px 15px 0 0;
        }

        .logo-section {
            display: flex;
            align-items: center;
            margin-left: -40px;
            margin-right: 500px;
        }

        .logo-section img {
            width: 150px;
            height: auto;
        }

        .logo-section h1 {
            color: #10203a;
            font-family: 'Konkhmer Sleokchher', serif;
            font-size: 2.5rem;
            font-weight: 650;
            margin-left: -30px;
        }

        nav {
            display: flex;
            gap: 3rem;
        }

        nav a {
            text-decoration: none;
            color: #000;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.4rem;
            font-weight: 400;
            transition: color 0.3s;
            cursor: pointer;
        }

        nav a:hover,
        nav a.active {
            color: #2563eb;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }
        }

        .friends-section h2 {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.875rem;
            color: #1F1E46;
            margin-top: 20px;
            margin-left: 20px;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .search-add-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .search-add-wrapper {
                flex-direction: row;
                gap: 1rem;
            }
        }

        .search-container {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            height: 59px;
            padding-left: 3rem;
            padding-right: 1rem;
            margin-left: 6px;
            margin-top: -1px;
            border-radius: 15px;
            border: none;
            font-family: 'KoHo', sans-serif;
            font-size: 1.25rem;
            color: #000;
            background: #fff;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            outline: none;
            transition: box-shadow 0.3s;
        }

        .search-icon {
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-friend-btn {
            height: 59px;
            padding: 0 1.5rem;
            background: linear-gradient(to right, #4A90E2, #357ABD);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            color: #fff;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
            font-weight: 400;
        }

        .add-friend-btn:hover {
            background: linear-gradient(to right, #5A9FF2, #4689CC);
        }

        .all-friends-tab {
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1.25rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 0.9375rem;
            background: transparent;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 400;
        }

        .tab-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .friends-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        @media (min-width: 640px) {
            .friends-grid {
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }
        }

        .friend-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .friend-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #C9D1D8;
            flex-shrink: 0;
        }

        .friend-name {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.3125rem;
            color: #000;
            font-weight: 400;
        }

        .friend-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .friend-points {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .star-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .points-text {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1rem;
            color: #000;
            font-weight: 400;
        }

        .remove-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1.125rem;
            background: transparent;
            color: #938F8F;
            cursor: pointer;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .add-btn-small {
            padding: 0.25rem 0.75rem;
            background: #34BDAD;
            border: none;
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1.125rem;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-btn-small:hover {
            background: #289c8e;
        }

        .sent-btn {
            padding: 0.25rem 0.75rem;
            background: #cbd5e1;
            border: none;
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1rem;
            color: #64748b;
            cursor: default;
        }

        .requests-section h2 {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.5rem;
            color: #000;
            margin-top: 30px;
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .requests-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            padding: 1rem;
        }

        .request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-name {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.25rem;
            color: #000;
            font-weight: 400;
            flex: 1;
        }

        .request-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 0.9375rem;
            font-weight: 400;
        }

        .accept-btn {
            color: #34BDAD;
        }

        .accept-circle {
            background: #34BDAD;
        }

        .decline-btn {
            color: #DC443F;
        }

        .decline-circle {
            background: #DC443F;
        }

        .action-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .decorative-images {
            display: none;
        }

        @keyframes fadeInAnimation {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            opacity: 0;
            animation: fadeInAnimation 1.5s ease-out forwards;
        }

        @media (min-width: 1024px) {
            .decorative-images {
                display: block;
            }

            .decorative-images img {
                position: absolute;
                opacity: 0.3;
                width: 138px;
                height: 60px;
                object-fit: contain;
            }

            .decorative-images img:nth-child(1) {
                top: 2rem;
                left: 2rem;
            }

            .decorative-images img:nth-child(2) {
                bottom: 2rem;
                right: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <img src="https://api.builder.io/api/v1/image/assets/TEMP/3205192e6eb58326a0090867bfed104d8aa10659?width=256"
                    alt="Studify Logo">
                <h1>studify</h1>
            </div>
            <nav>
                <a href="Profile.html">Profile</a>
                <a href="Home.html">Home</a>
                <a href="#about">log out</a>
            </nav>
        </header>

        <div class="main-grid">
            <div class="friends-section">
                <h2 id="listTitle">My Friends</h2>

                <div class="search-add-wrapper">
                    <div class="search-container">
                        <div class="search-icon">
                            <svg width="18" height="19" viewBox="0 0 18 19" fill="none">
                                <ellipse cx="9" cy="9.5" rx="9" ry="9.5" fill="#FCF8FA" />
                                <path
                                    d="M9 0.5C13.6693 0.5 17.5 4.50362 17.5 9.5C17.5 14.4964 13.6693 18.5 9 18.5C4.33071 18.5 0.5 14.4964 0.5 9.5C0.5 4.50362 4.33071 0.5 9 0.5Z"
                                    stroke="black" stroke-opacity="0.22" />
                            </svg>
                        </div>
                        <input type="text" class="search-input" placeholder="Search new friends to add..."
                            id="searchInput">
                    </div>
                    <button class="add-friend-btn" onclick="document.getElementById('searchInput').focus()">Add
                        Friend</button>
                </div>

                <div class="all-friends-tab">
                    <button class="tab-btn" id="tabBtn">All Friends</button>
                </div>

                <div class="friends-grid" id="friendsContainer"></div>
            </div>

            <div class="requests-section">
                <h2>Friend Requests</h2>
                <div class="requests-card" id="requestsContainer"></div>
            </div>
        </div>

    </div>
    </div>

   
    <script>
        // Placeholder for the base API URL. Replace with your actual backend URL.
        const API_BASE_URL = 'https://studify-dye7gqa7hfchgzdk.italynorth-01.azurewebsites.net';

        // Global state for friends and requests
        let friends = [];
        let friendRequests = [];
        let allUsersOnServer = []; // Only for search functionality

        // --- 1. Utility Functions for API Calls ---

        /**
         * Fetches data from a given endpoint.
         * @param {string} endpoint - The API path (e.g., '/friends').
         * @returns {Promise<Object[] | null>} The fetched data or null on error.
         */
        async function fetchData(endpoint) {
            try {
                // Assuming you might need an Authorization header with a token
                // const token = localStorage.getItem('authToken'); 
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': Bearer ${token}, // Uncomment if needed
                    },
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("Error fetching data from " + endpoint + ":", error);
                return null;
            }
        }

        /**
         * Sends a POST/PUT/DELETE request to the API.
         * @param {string} endpoint - The API path.
         * @param {string} method - HTTP method ('POST', 'PUT', 'DELETE').
         * @param {Object} [data] - The body data for POST/PUT.
         * @returns {Promise<boolean>} True if the operation was successful, false otherwise.
         */
        async function sendMutation(endpoint, method, data = null) {
            try {
                const body = data ? JSON.stringify(data) : undefined;
                
                // const token = localStorage.getItem('authToken'); // Uncomment if needed

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        // 'Authorization': Bearer ${token}, // Uncomment if needed
                    },
                    body: body,
                });

                if (!response.ok) {
                    // Check for specific backend errors if your API returns them
                    // const errorData = await response.json();
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return true;
            } catch (error) {
                console.error(`Error during ${method} operation to ${endpoint}:, error`);
                // alert(Failed to complete action: ${error.message});
                return false;
            }
        }


        // --- 2. Data Initialization (Loading) ---

        /**
         * Loads all necessary data from the backend.
         */
        async function loadAllData() {
            // Fetch friends
            const fetchedFriends = await fetchData('/friends');
            if (fetchedFriends) {
                // Assuming the backend returns an array of friend objects: 
                // [{ id: 1, name: "Ahmed Ali", points: 1250 }, ...]
                friends = fetchedFriends;
            }

            // Fetch friend requests
            const fetchedRequests = await fetchData('/requests');
            if (fetchedRequests) {
                // Assuming the backend returns an array of request objects: 
                // [{ id: 101, name: "Pending Friend 1" }, ...]
                friendRequests = fetchedRequests;
            }
            // Fetch all users for search (This might be a large operation, 
            // often better to search directly on the server)
            const fetchedUsers = await fetchData('/users');
            if (fetchedUsers) {
                // Assuming the backend returns an array of user objects: 
                // [{ id: 201, name: "Omar Hassan", points: 500 }, ...]
                allUsersOnServer = fetchedUsers;
            }
            
            // Render the UI after all data is loaded
            renderFriends();
            renderRequests();
        }

        // --- 3. Rendering Functions (These remain largely the same) ---

        // The rendering functions now rely on the global 'friends', 'friendRequests', 
        // and 'allUsersOnServer' arrays populated by loadAllData().

        function renderFriends() {
            const container = document.getElementById('friendsContainer');
            document.getElementById('listTitle').innerText = "My Friends";
            document.getElementById('tabBtn').innerText = "All Friends";

            if (friends.length === 0) {
                container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: #777;">No friends yet.</p>';
                return;
            }

            container.innerHTML = friends.map(friend => `
                <div class="friend-card">
                    <div class="friend-header">
                        <div class="friend-avatar"></div>
                        <h3 class="friend-name">${friend.name}</h3>
                    </div>
                    <div class="friend-footer">
                        <div class="friend-points">
                            <svg class="star-icon" viewBox="0 0 24 23" fill="none"><path d="M11.8882 0L14.6946 8.63729H23.7764L16.4291 13.9754L19.2355 22.6127L11.8882 17.2746L4.54089 22.6127L7.34732 13.9754L0 8.63729H9.08178L11.8882 0Z" fill="#FCC65A"/></svg>
                            <span class="points-text">${friend.points} Points</span>
                        </div>
                        <button class="remove-btn" onclick="removeFriend(${friend.id})">Remove</button>
                    </div>
                </div>
           ` ).join('');
        }

        function renderSearchResults(results) {
            const container = document.getElementById('friendsContainer');
            document.getElementById('listTitle').innerText = "Search Results";
            document.getElementById('tabBtn').innerText = "Back to Friends";

            if (results.length === 0) {
                container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: #938F8F; padding: 2rem;">No users found.</p>';
                return;
            }

            // Get IDs of current friends and those who already have a pending request
            const myFriendIds = friends.map(f => f.id);
            const pendingRequestUserIds = friendRequests.map(r => r.id); 

            container.innerHTML = results.map(user => {
                let buttonHtml = '';
                if (myFriendIds.includes(user.id)) {
                    // Should not happen if search logic is correct, but good for safety
                    buttonHtml = '<button class="sent-btn" disabled>Already Friends</button>';
                } else if (pendingRequestUserIds.includes(user.id)) {
                    buttonHtml = '<button class="sent-btn" disabled>Request Sent</button>';
                } else {
                    // Note: Passed 'user.id' to identify the target user
                    buttonHtml = <button class="add-btn-small" onclick="sendFriendRequest(this, ${user.id})">Add Friend</button>;
                }

                return `
                    <div class="friend-card">
                        <div class="friend-header">
                            <div class="friend-avatar" style="background: #a0aec0;"></div>
                            <h3 class="friend-name">${user.name}</h3>
                        </div>
                        <div class="friend-footer">
                            <div class="friend-points">
                                <span class="points-text" style="font-size: 0.9rem; color: #666;">User Points: ${user.points}</span>
                            </div>
                            ${buttonHtml}
                        </div>
                    </div>
                ;   `
            }).join('');
        }
                 function renderRequests() {
            const container = document.getElementById('requestsContainer');
            if (friendRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777;">No new requests.</p>';
                return;
            }
            container.innerHTML = friendRequests.map(req => `
                <div class="request-item">
                    <span class="request-name">${req.name}</span>
                    <div class="request-actions">
                        <button class="action-btn accept-btn" onclick="acceptRequest(${req.id})">
                            <div class="action-circle accept-circle"></div> Accept
                        </button>
                        <button class="action-btn decline-btn" onclick="declineRequest(${req.id})">
                            <div class="action-circle decline-circle"></div> Decline
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // --- 4. Logic Functions (Now Asynchronous) ---

        // Searching logic remains mostly the same, but relies on 'allUsersOnServer'
        document.getElementById('searchInput').addEventListener('input', function (e) {
            const query = e.target.value.toLowerCase();
            if (query === "") {
                renderFriends();
                return;
            }
            
            // Get IDs of current friends AND users who have pending requests (to avoid double actions)
            const myFriendIds = friends.map(f => f.id);
            const pendingRequestUserIds = friendRequests.map(r => r.id);
            const excludedIds = [...myFriendIds, ...pendingRequestUserIds];
            
            const results = allUsersOnServer.filter(user =>
                user.name.toLowerCase().includes(query) &&
                !excludedIds.includes(user.id)
            );
            renderSearchResults(results);
        });

        // Tab click to reset search
        document.getElementById('tabBtn').addEventListener('click', function () {
            document.getElementById('searchInput').value = "";
            renderFriends();
        });


        /**
         * Sends a friend request to a user.
         * @param {HTMLElement} btn - The button element clicked.
         * @param {number} targetUserId - The ID of the user to send the request to.
         */
        async function sendFriendRequest(btn, targetUserId) {
            // 1. Disable button and show loading/pending state immediately for better UX
            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            // 2. Call the API
            // Assuming the backend has an endpoint like POST /send-request with the targetUserId in the body
            const success = await sendMutation(`/requests/send`, 'POST', { targetUserId: targetUserId });

            // 3. Handle the result
            if (success) {
                btn.innerText = "Request Sent";
                btn.className = "sent-btn";
                // No need to re-render all users for search, as the state is correct on the server
                } else {
                // Revert button state on failure
                btn.innerText = originalText;
                btn.disabled = false;
                alert("Failed to send friend request. Please try again.");
            }
        }


        /**
         * Accepts a friend request.
         * @param {number} requestId - The ID of the request to accept.
         */
        async function acceptRequest(requestId) {
            // 1. Optimistic UI update (optional, but faster feeling)
            // Save the original request item temporarily
            const originalRequest = friendRequests.find(r => r.id === requestId);
            
            // Filter out the accepted request for immediate visual update
            friendRequests = friendRequests.filter(r => r.id !== requestId);
            renderRequests(); // Update the request list

            // 2. Call the API
            // Assuming the backend has an endpoint like PUT /requests/accept/:requestId
            const success = await sendMutation(`/requests/${requestId}/accept`, 'PUT');

            // 3. Handle the result
            if (success) {
                // If successful, re-fetch all data to ensure friend and request lists are up-to-date
                await loadAllData(); 
            } else {
                // Revert UI update and show an error
                if (originalRequest) friendRequests.push(originalRequest);
                renderRequests();
                alert("Failed to accept request. Please try again.");
            }
        }

        /**
         * Declines a friend request.
         * @param {number} requestId - The ID of the request to decline.
         */
        async function declineRequest(requestId) {
             // 1. Optimistic UI update (optional)
            const originalRequest = friendRequests.find(r => r.id === requestId);
            friendRequests = friendRequests.filter(r => r.id !== requestId);
            renderRequests(); 

            // 2. Call the API
            // Assuming the backend has an endpoint like DELETE /requests/:requestId
            const success = await sendMutation(`/requests/${requestId}`, 'DELETE');

            // 3. Handle the result
            if (!success) {
                // Revert UI update and show an error
                if (originalRequest) friendRequests.push(originalRequest);
                renderRequests();
                alert("Failed to decline request. Please try again.");
            }
            // If successful, the UI is already updated, no need to re-fetch unless you want to be extra safe
            // await loadAllData();
        }

        /**
         * Removes a friend.
         * @param {number} friendId - The ID of the friend to remove.
         */
        async function removeFriend(friendId) {
            if (confirm("Remove this friend permanently?")) {
                // 1. Optimistic UI update
                const originalFriend = friends.find(f => f.id === friendId);
                friends = friends.filter(f => f.id !== friendId);
                renderFriends();

                // 2. Call the API
                // Assuming the backend has an endpoint like DELETE /friends/:friendId
                const success = await sendMutation(`/friends/${friendId}`, 'DELETE');

                // 3. Handle the result
                if (success) {
                    // Update the search users list, so the person can be found again
                    await loadAllData(); 
                } else {
                    // Revert UI update and show an error
                    if (originalFriend) friends.push(originalFriend);
                    renderFriends();
                    alert("Failed to remove friend. Please try again.");
                }
            }
        }

        // --- 5. Initial Run ---
        // Start by loading all data from the backend
        loadAllData();

    </script>
</body>

</html>