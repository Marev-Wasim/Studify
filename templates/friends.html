<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studify - My Friends</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Konkhmer+Sleokchher&family=KoHo:wght@400;500;600&family=Inter:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* * Ÿáÿ∞ÿß ÿßŸÑÿ¨ÿ≤ÿ° Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ CSS ÿßŸÑÿÆÿßÿµÿ© ÿ®ÿßŸÑÿµŸÅÿ≠ÿ©
         * ÿ™ŸÖ ÿßŸÑÿ•ÿ®ŸÇÿßÿ° ÿπŸÑŸäŸá ŸÉŸÖÿß ÿ£ÿ±ÿ≥ŸÑÿ™Ÿá ÿ≥ÿßÿ®ŸÇÿßŸã
         */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #abd1f4;
            min-height: 105vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1250px;
            min-height: 700px;
            background: #EBF6FF;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            position: relative;
        }

        header {
            height: 124px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 3rem;
            background: white;
            border-bottom: 1px solid #f3f4f6;
            margin: -2rem -2rem 2rem -2rem;
            width: calc(100% + 4rem);
            border-radius: 15px 15px 0 0;
        }

        .logo-section {
            display: flex;
            align-items: center;
            margin-left: -40px;
            margin-right: 500px;
        }

        .logo-section img {
            width: 150px;
            height: auto;
        }

        .logo-section h1 {
            color: #10203a;
            font-family: 'Konkhmer Sleokchher', serif;
            font-size: 2.5rem;
            font-weight: 650;
            margin-left: -30px;
        }

        nav {
            display: flex;
            gap: 3rem;
        }

        nav a {
            text-decoration: none;
            color: #000;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.4rem;
            font-weight: 400;
            transition: color 0.3s;
            cursor: pointer;
        }

        nav a:hover,
        nav a.active {
            color: #2563eb;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }
        }

        .friends-section h2 {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.875rem;
            color: #1F1E46;
            margin-top: 20px;
            margin-left: 20px;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .search-add-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .search-add-wrapper {
                flex-direction: row;
                gap: 1rem;
            }
        }

        .search-container {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            height: 59px;
            padding-left: 3rem;
            padding-right: 1rem;
            margin-left: 6px;
            margin-top: -1px;
            border-radius: 15px;
            border: none;
            font-family: 'KoHo', sans-serif;
            font-size: 1.25rem;
            color: #000;
            background: #fff;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            outline: none;
            transition: box-shadow 0.3s;
        }

        .search-icon {
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-friend-btn {
            height: 59px;
            padding: 0 1.5rem;
            background: linear-gradient(to right, #4A90E2, #357ABD);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            color: #fff;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
            font-weight: 400;
        }

        .add-friend-btn:hover {
            background: linear-gradient(to right, #5A9FF2, #4689CC);
        }

        .all-friends-tab {
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1.25rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 0.9375rem;
            background: transparent;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 400;
        }

        .tab-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .friends-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        @media (min-width: 640px) {
            .friends-grid {
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }
        }

        .friend-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .friend-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #C9D1D8;
            flex-shrink: 0;
        }

        .friend-name {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.3125rem;
            color: #000;
            font-weight: 400;
        }

        .friend-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .friend-points {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .star-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .points-text {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1rem;
            color: #000;
            font-weight: 400;
        }

        .remove-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1.125rem;
            background: transparent;
            color: #938F8F;
            cursor: pointer;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .add-btn-small {
            padding: 0.25rem 0.75rem;
            background: #34BDAD;
            border: none;
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1.125rem;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-btn-small:hover {
            background: #289c8e;
        }

        .sent-btn {
            padding: 0.25rem 0.75rem;
            background: #cbd5e1;
            border: none;
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1rem;
            color: #64748b;
            cursor: default;
        }

        .requests-section h2 {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.5rem;
            color: #000;
            margin-top: 30px;
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .requests-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            padding: 1rem;
        }

        .request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-name {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.25rem;
            color: #000;
            font-weight: 400;
            flex: 1;
        }

        .request-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 0.9375rem;
            font-weight: 400;
        }

        .accept-btn {
            color: #34BDAD;
        }

        .accept-circle {
            background: #34BDAD;
        }

        .decline-btn {
            color: #DC443F;
        }

        .decline-circle {
            background: #DC443F;
        }

        .action-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .decorative-images {
            display: none;
        }

        @keyframes fadeInAnimation {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            opacity: 0;
            animation: fadeInAnimation 1.5s ease-out forwards;
        }

        @media (min-width: 1024px) {
            .decorative-images {
                display: block;
            }

            .decorative-images img {
                position: absolute;
                opacity: 0.3;
                width: 138px;
                height: 60px;
                object-fit: contain;
            }

            .decorative-images img:nth-child(1) {
                top: 2rem;
                left: 2rem;
            }

            .decorative-images img:nth-child(2) {
                bottom: 2rem;
                right: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <img src="https://api.builder.io/api/v1/image/assets/TEMP/3205192e6eb58326a0090867bfed104d8aa10659?width=256"
                    alt="Studify Logo">
                <h1>studify</h1>
            </div>
            <nav>
                <a href="/profile-page">Profile</a>
                <a href="/dashboard-page">Home</a>
                <a href="/auth/logout">Log out</a>
            </nav>
        </header>

        <div class="main-grid">
            <div class="friends-section">
                <h2 id="listTitle">My Friends</h2>

                <div class="search-add-wrapper">
                    <div class="search-container">
                        <div class="search-icon">
                            <svg width="18" height="19" viewBox="0 0 18 19" fill="none">
                                <ellipse cx="9" cy="9.5" rx="9" ry="9.5" fill="#FCF8FA" />
                                <path
                                    d="M9 0.5C13.6693 0.5 17.5 4.50362 17.5 9.5C17.5 14.4964 13.6693 18.5 9 18.5C4.33071 18.5 0.5 14.4964 0.5 9.5C0.5 4.50362 4.33071 0.5 9 0.5Z"
                                    stroke="black" stroke-opacity="0.22" />
                            </svg>
                        </div>
                        <input type="text" class="search-input" placeholder="Search new friends to add..."
                            id="searchInput">
                    </div>
                    <button class="add-friend-btn" onclick="document.getElementById('searchInput').focus()">Add
                        Friend</button>
                </div>

                <div class="all-friends-tab">
                    <button class="tab-btn" id="tabBtn">All Friends</button>
                </div>

                <div class="friends-grid" id="friendsContainer"></div>
            </div>

            <div class="requests-section">
                <h2>Friend Requests</h2>
                <div class="requests-card" id="requestsContainer"></div>
            </div>
        </div>

    </div>
    </div>


    <script>
    const API_BASE_URL = 'https://studify-dye7gqa7hfchgzdk.italynorth-01.azurewebsites.net';

    let friends = [];
    let friendRequests = [];
    let allUsersOnServer = []; 

    async function fetchData(endpoint) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: 'GET',
                headers: { 'Content-Type': 'application/json' },
            });
            if (response.status === 401) {
                window.location.href = '/index-page';
                return null;
            }
            if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
            return await response.json();
        } catch (error) {
            console.error("Error fetching data:", error);
            return null;
        }
    }

    async function sendMutation(endpoint, method, data = null) {
        try {
            const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: data ? JSON.stringify(data) : undefined,
            });
            return response.ok;
        } catch (error) {
            return false;
        }
    }

    // --- üü¢ ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ ŸÑŸÖŸÑÿ° ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÅŸÇŸàÿØÿ© ---
    async function loadAllData() {
        const fetchedFriends = await fetchData('/friends/');
        if (fetchedFriends) {
            friends = fetchedFriends;
        }

        const fetchedRequests = await fetchData('/friends/pending');
        if (fetchedRequests) {
            // ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÑÿ™ÿ™ŸàÿßŸÅŸÇ ŸÖÿπ ÿßŸÑÿ™ÿµŸÖŸäŸÖ
            friendRequests = fetchedRequests.map(req => ({
                ...req,
                name: req.sender_username, // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿßÿ≥ŸÖ ÿßŸÑŸÇÿßÿØŸÖ ŸÖŸÜ ÿßŸÑÿ®ÿßŸäÿ´ŸàŸÜ
                // ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑÿ®ÿßŸÉ ÿ•ŸÜÿØ ŸÑÿß Ÿäÿ±ÿ≥ŸÑ IDÿå ÿ≥ÿ™ÿ≠ÿ™ÿßÿ¨ŸäŸÜ ŸÑÿ™ÿπÿØŸäŸÑŸá ŸÑÿßÿ≠ŸÇÿßŸã 
                // ŸÑŸäÿ™ŸÖŸÉŸÜ ÿßŸÑÿ≤ÿ± ŸÖŸÜ ÿßŸÑÿπŸÖŸÑÿå ŸÑŸÉŸÜ ÿßŸÑÿ¢ŸÜ ÿ≥Ÿäÿ∏Ÿáÿ± ÿßŸÑÿßÿ≥ŸÖ ÿπŸÑŸâ ÿßŸÑÿ£ŸÇŸÑ.
            }));
        }
        
        renderFriends();
        renderRequests();
    }

    function renderFriends() {
        const container = document.getElementById('friendsContainer');
        container.innerHTML = friends.length === 0 ? '<p>No friends yet.</p>' : 
        friends.map(friend => `
            <div class="friend-card">
                <div class="friend-header">
                    <div class="friend-avatar"></div>
                    <h3 class="friend-name">${friend.username}</h3>
                </div>
                <div class="friend-footer">
                    <button class="remove-btn" onclick="removeFriend(${friend.id})">Remove</button>
                </div>
            </div>
        `).join('');
    }

    // --- üü¢ ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ∑ŸÑÿ®ÿßÿ™ ŸÑÿ™ŸÜÿßÿ≥ÿ® ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ®ÿßŸäÿ´ŸàŸÜ ---
    function renderRequests() {
        const container = document.getElementById('requestsContainer');
        if (friendRequests.length === 0) {
            container.innerHTML = '<p style="text-align: center; color: #777;">No new requests.</p>';
            return;
        }
        container.innerHTML = friendRequests.map(req => `
            <div class="request-item">
                <span class="request-name">${req.sender_username}</span> <div class="request-actions">
                    <button class="action-btn accept-btn" onclick="acceptRequest(${req.sender_id})">
                        <div class="action-circle accept-circle"></div> Accept
                    </button>
                    <button class="action-btn decline-btn" onclick="declineRequest(${req.request_id})">
                        <div class="action-circle decline-circle"></div> Decline
                    </button>
                </div>
            </div>
        `).join('');
    }

    async function fetchAndRenderSearchResults(query) {
        if (query.length === 0) { renderFriends(); return; }
        const fetchedResults = await fetchData(`/friends/users/search?q=${encodeURIComponent(query)}`);
        if (fetchedResults) {
            renderSearchResults(fetchedResults);
        }
    }

    function renderSearchResults(results) {
        const container = document.getElementById('friendsContainer');
        document.getElementById('listTitle').innerText = "Search Results";
        container.innerHTML = results.map(user => `
            <div class="friend-card">
                <div class="friend-header">
                    <div class="friend-avatar" style="background: #a0aec0;"></div>
                    <h3 class="friend-name">${user.username}</h3>
                </div>
                <div class="friend-footer">
                    <button class="add-btn-small" onclick="sendFriendRequest(this, '${user.username}')">Add Friend</button>
                </div>
            </div>
        `).join('');
    }

    document.getElementById('searchInput').addEventListener('input', (e) => fetchAndRenderSearchResults(e.target.value.trim()));
    document.getElementById('tabBtn').addEventListener('click', () => { document.getElementById('searchInput').value = ""; renderFriends(); });

    async function sendFriendRequest(btn, targetUsername) {
        btn.innerText = "Sending...";
        const success = await sendMutation('/friends/request', 'POST', { friend_username: targetUsername });
        if (success) { btn.innerText = "Sent"; loadAllData(); }
    }

    async function acceptRequest(senderId) {
        const success = await sendMutation('/friends/accept', 'PUT', { sender_id: senderId });
        if (success) loadAllData();
    }

    async function declineRequest(requestId) {
        const success = await sendMutation(`/friends/${requestId}`, 'DELETE');
        if (success) loadAllData();
    }

    async function removeFriend(otherUserId) {
        if (confirm("Remove friend?")) {
            const success = await sendMutation(`/friends/${otherUserId}`, 'DELETE');
            if (success) loadAllData();
        }
    }

    window.addEventListener('load', loadAllData);
        
</script>
</body>

</html>

