<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studify - My Friends</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Konkhmer+Sleokchher&family=KoHo:wght@400;500;600&family=Inter:wght@400;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        /* * Ù‡Ø°Ø§ Ø§Ù„Ø¬Ø²Ø¡ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚Ø§Øª CSS Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„ØµÙØ­Ø©
         * ØªÙ… Ø§Ù„Ø¥Ø¨Ù‚Ø§Ø¡ Ø¹Ù„ÙŠÙ‡ ÙƒÙ…Ø§ Ø£Ø±Ø³Ù„ØªÙ‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹
         */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', system-ui, sans-serif;
            background: #abd1f4;
            min-height: 105vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .container {
            width: 100%;
            max-width: 1250px;
            min-height: 700px;
            background: #EBF6FF;
            border-radius: 15px;
            padding: 2rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4);
            overflow: hidden;
            position: relative;
        }

        header {
            height: 124px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 3rem;
            background: white;
            border-bottom: 1px solid #f3f4f6;
            margin: -2rem -2rem 2rem -2rem;
            width: calc(100% + 4rem);
            border-radius: 15px 15px 0 0;
        }

        .logo-section {
            display: flex;
            align-items: center;
            margin-left: -40px;
            margin-right: 500px;
        }

        .logo-section img {
            width: 150px;
            height: auto;
        }

        .logo-section h1 {
            color: #10203a;
            font-family: 'Konkhmer Sleokchher', serif;
            font-size: 2.5rem;
            font-weight: 650;
            margin-left: -30px;
        }

        nav {
            display: flex;
            gap: 3rem;
        }

        nav a {
            text-decoration: none;
            color: #000;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.4rem;
            font-weight: 400;
            transition: color 0.3s;
            cursor: pointer;
        }

        nav a:hover,
        nav a.active {
            color: #2563eb;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        @media (min-width: 1024px) {
            .main-grid {
                grid-template-columns: 2fr 1fr;
                gap: 2rem;
            }
        }

        .friends-section h2 {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.875rem;
            color: #1F1E46;
            margin-top: 20px;
            margin-left: 20px;
            margin-bottom: 1.5rem;
            font-weight: 400;
        }

        .search-add-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        @media (min-width: 640px) {
            .search-add-wrapper {
                flex-direction: row;
                gap: 1rem;
            }
        }

        .search-container {
            position: relative;
            flex: 1;
        }

        .search-input {
            width: 100%;
            height: 59px;
            padding-left: 3rem;
            padding-right: 1rem;
            margin-left: 6px;
            margin-top: -1px;
            border-radius: 15px;
            border: none;
            font-family: 'KoHo', sans-serif;
            font-size: 1.25rem;
            color: #000;
            background: #fff;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            outline: none;
            transition: box-shadow 0.3s;
        }

        .search-icon {
            position: absolute;
            left: 1.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .add-friend-btn {
            height: 59px;
            padding: 0 1.5rem;
            background: linear-gradient(to right, #4A90E2, #357ABD);
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            color: #fff;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.25rem;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
            font-weight: 400;
        }

        .add-friend-btn:hover {
            background: linear-gradient(to right, #5A9FF2, #4689CC);
        }

        .all-friends-tab {
            margin-bottom: 1.5rem;
        }

        .tab-btn {
            padding: 0.5rem 1.25rem;
            border: 1px solid rgba(0, 0, 0, 0.05);
            border-radius: 10px;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 0.9375rem;
            background: transparent;
            cursor: pointer;
            transition: background 0.3s;
            font-weight: 400;
        }

        .tab-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .friends-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
            max-height: 500px;
            overflow-y: auto;
            padding: 5px;
        }

        @media (min-width: 640px) {
            .friends-grid {
                grid-template-columns: 1fr 1fr;
                gap: 1.5rem;
            }
        }

        .friend-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .friend-header {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .friend-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #C9D1D8;
            flex-shrink: 0;
        }

        .friend-name {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.3125rem;
            color: #000;
            font-weight: 400;
        }

        .friend-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
        }

        .friend-points {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .star-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .points-text {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1rem;
            color: #000;
            font-weight: 400;
        }

        .remove-btn {
            padding: 0.25rem 0.75rem;
            border: 1px solid rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1.125rem;
            background: transparent;
            color: #938F8F;
            cursor: pointer;
            transition: background 0.3s;
        }

        .remove-btn:hover {
            background: rgba(0, 0, 0, 0.05);
        }

        .add-btn-small {
            padding: 0.25rem 0.75rem;
            background: #34BDAD;
            border: none;
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1.125rem;
            color: white;
            cursor: pointer;
            transition: background 0.3s;
        }

        .add-btn-small:hover {
            background: #289c8e;
        }

        .sent-btn {
            padding: 0.25rem 0.75rem;
            background: #cbd5e1;
            border: none;
            border-radius: 10px;
            font-family: 'KoHo', sans-serif;
            font-size: 1rem;
            color: #64748b;
            cursor: default;
        }

        .requests-section h2 {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.5rem;
            color: #000;
            margin-top: 30px;
            margin-bottom: 1rem;
            font-weight: 400;
        }

        .requests-card {
            background: #fff;
            border-radius: 15px;
            box-shadow: 0 4px 4px 0 rgba(0, 0, 0, 0.25);
            padding: 1rem;
        }

        .request-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            padding: 1rem 0;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .request-item:last-child {
            border-bottom: none;
        }

        .request-name {
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 1.25rem;
            color: #000;
            font-weight: 400;
            flex: 1;
        }

        .request-actions {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .action-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            background: none;
            border: none;
            cursor: pointer;
            font-family: 'Konkhmer Sleokchher', sans-serif;
            font-size: 0.9375rem;
            font-weight: 400;
        }

        .accept-btn {
            color: #34BDAD;
        }

        .accept-circle {
            background: #34BDAD;
        }

        .decline-btn {
            color: #DC443F;
        }

        .decline-circle {
            background: #DC443F;
        }

        .action-circle {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .decorative-images {
            display: none;
        }

        @keyframes fadeInAnimation {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .container {
            opacity: 0;
            animation: fadeInAnimation 1.5s ease-out forwards;
        }

        @media (min-width: 1024px) {
            .decorative-images {
                display: block;
            }

            .decorative-images img {
                position: absolute;
                opacity: 0.3;
                width: 138px;
                height: 60px;
                object-fit: contain;
            }

            .decorative-images img:nth-child(1) {
                top: 2rem;
                left: 2rem;
            }

            .decorative-images img:nth-child(2) {
                bottom: 2rem;
                right: 2rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <div class="logo-section">
                <img src="https://api.builder.io/api/v1/image/assets/TEMP/3205192e6eb58326a0090867bfed104d8aa10659?width=256"
                    alt="Studify Logo">
                <h1>studify</h1>
            </div>
            <nav>
                <a href="/profile-page">Profile</a>
                <a href="/dashboard-page">Home</a>
                <a href="/auth/logout">Log out</a>
            </nav>
        </header>

        <div class="main-grid">
            <div class="friends-section">
                <h2 id="listTitle">My Friends</h2>

                <div class="search-add-wrapper">
                    <div class="search-container">
                        <div class="search-icon">
                            <svg width="18" height="19" viewBox="0 0 18 19" fill="none">
                                <ellipse cx="9" cy="9.5" rx="9" ry="9.5" fill="#FCF8FA" />
                                <path
                                    d="M9 0.5C13.6693 0.5 17.5 4.50362 17.5 9.5C17.5 14.4964 13.6693 18.5 9 18.5C4.33071 18.5 0.5 14.4964 0.5 9.5C0.5 4.50362 4.33071 0.5 9 0.5Z"
                                    stroke="black" stroke-opacity="0.22" />
                            </svg>
                        </div>
                        <input type="text" class="search-input" placeholder="Search new friends to add..."
                            id="searchInput">
                    </div>
                    <button class="add-friend-btn" onclick="document.getElementById('searchInput').focus()">Add
                        Friend</button>
                </div>

                <div class="all-friends-tab">
                    <button class="tab-btn" id="tabBtn">All Friends</button>
                </div>

                <div class="friends-grid" id="friendsContainer"></div>
            </div>

            <div class="requests-section">
                <h2>Friend Requests</h2>
                <div class="requests-card" id="requestsContainer"></div>
            </div>
        </div>

    </div>
    </div>


    <script>
        // Placeholder for the base API URL. Replace with your actual backend URL.
        const API_BASE_URL = 'https://studify-dye7gqa7hfchgzdk.italynorth-01.azurewebsites.net';

        // Global state for friends and requests
        let friends = [];
        let friendRequests = [];
        let allUsersOnServer = []; // Ù„Ù† Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„ÙŠÙ‡Ø§ ÙÙŠ Ø§Ù„Ø¨Ø­Ø«ØŒ Ù„ÙƒÙ† Ù†Ø¨Ù‚ÙŠÙ‡Ø§ ÙØ§Ø±ØºØ©

        // --- 1. Utility Functions for API Calls ---

        /**
         * Fetches data from a given endpoint.
         * @param {string} endpoint - The API path (e.g., '/friends/').
         * @returns {Promise<Object[] | null>} The fetched data or null on error.
         */
        async function fetchData(endpoint) {
            try {
                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' },
                });

                if (response.status === 401) {
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ØµØ±Ø­Ù‹Ø§ØŒ Ø£Ø¹Ø¯ Ø§Ù„ØªÙˆØ¬ÙŠÙ‡ Ù„ØµÙØ­Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
                    alert("Error: Authentication required (User must be logged in).");
                    window.location.href = '/index-page';
                    return null;
                }

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                return await response.json();
            } catch (error) {
                console.error("Error fetching data from " + endpoint + ":", error);
                return null;
            }
        }

        /**
         * Sends a POST/PUT/DELETE request to the API.
         * @param {string} endpoint - The API path.
         * @param {string} method - HTTP method ('POST', 'PUT', 'DELETE').
         * @param {Object} [data] - The body data for POST/PUT.
         * @returns {Promise<boolean>} True if the operation was successful, false otherwise.
         */
        async function sendMutation(endpoint, method, data = null) {
            try {
                const body = data ? JSON.stringify(data) : undefined;

                const response = await fetch(`${API_BASE_URL}${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: body,
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    const errorMessage = errorData.message || `HTTP error! status: ${response.status}`;
                    alert(`Failed to complete action: ${errorMessage}`);
                    throw new Error(errorMessage);
                }

                return true;
            } catch (error) {
                console.error(`Error during ${method} operation to ${endpoint}:`, error);
                return false;
            }
        }


        // --- 2. Data Initialization (Loading) ---

        /**
         * Loads all necessary data from the backend.
         */
        async function loadAllData() {
            // Fetch friends
            const fetchedFriends = await fetchData('/friends/');
            if (fetchedFriends) {
                // Ù†Ø³ØªØ®Ø¯Ù… friend.username ÙƒÙ€ friend.name Ù…Ø¤Ù‚ØªØ§Ù‹
                friends = fetchedFriends.map(f => ({
                    ...f,
                    name: f.username,
                    // Ø³Ù†ÙØªØ±Ø¶ Ø£Ù† ID Ø§Ù„Ø¹Ù„Ø§Ù‚Ø© ÙˆØ§Ù„Ù€ ID Ø§Ù„Ø´Ø®ØµÙŠ Ù…ÙˆØ¬ÙˆØ¯ÙŠÙ† ÙÙŠ f.id Ùˆ f.relationship_id
                }));
            }

            // Fetch friend requests
            const fetchedRequests = await fetchData('/friends/pending');
            if (fetchedRequests) {
                friendRequests = fetchedRequests.map(req => ({
                    ...req,
                    name: req.sender_username,
                    // ğŸš¨ [ØªØ°ÙƒÙŠØ±]: ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙØ±Ø¬Ø¹ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯: request_id Ùˆ sender_id (Ø§Ù„Ø°ÙŠ Ù‡Ùˆ ID Ø§Ù„Ù…Ø±Ø³Ù„)
                    // Ù†ÙØªØ±Ø¶ Ù‡Ù†Ø§ Ø£Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ù…ÙˆØ¬ÙˆØ¯Ø© (req.request_id Ùˆ req.sender_id)
                }));
            }
            
            // Ø¥Ù„ØºØ§Ø¡ Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ allUsersOnServer Ù„ÙƒÙŠ Ù„Ø§ ØªÙØ´Ù„ Ø¯Ø§Ù„Ø© loadAllData()
            allUsersOnServer = [];

            // Render the UI after all data is loaded
            renderFriends();
            renderRequests();
        }

        // --- 3. Rendering Functions ---

        function renderFriends() {
            const container = document.getElementById('friendsContainer');
            document.getElementById('listTitle').innerText = "My Friends";
            document.getElementById('tabBtn').innerText = "All Friends";

            if (friends.length === 0) {
                container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: #777;">No friends yet.</p>';
                return;
            }

            container.innerHTML = friends.map(friend => {
                // ğŸš¨ [Ù…Ù„Ø§Ø­Ø¸Ø©]: Ù‡Ù†Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ø£Ù† friend.id Ù‡Ùˆ ID Ø§Ù„ØµØ¯ÙŠÙ‚ Ø§Ù„Ø¢Ø®Ø±ØŒ 
                // ÙˆÙ‡Ùˆ Ù…Ø§ ÙŠØªÙˆÙ‚Ø¹Ù‡ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯ ÙÙŠ Ù…Ø³Ø§Ø± Ø§Ù„Ø­Ø°Ù /friends/:otherUserId
                
                return `
                    <div class="friend-card">
                        <div class="friend-header">
                            <div class="friend-avatar"></div>
                            <h3 class="friend-name">${friend.name || friend.username}</h3>
                        </div>
                        <div class="friend-footer">
                            <div class="friend-points">
                                <svg class="star-icon" viewBox="0 0 24 23" fill="none"><path d="M11.8882 0L14.6946 8.63729H23.7764L16.4291 13.9754L19.2355 22.6127L11.8882 17.2746L4.54089 22.6127L7.34732 13.9754L0 8.63729H9.08178L11.8882 0Z" fill="#FCC65A"/></svg>
                                <span class="points-text">${friend.points || 0} Points</span>
                            </div>
                            <button class="remove-btn" onclick="removeFriend(${friend.id})">Remove</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderSearchResults(results) {
            const container = document.getElementById('friendsContainer');
            document.getElementById('listTitle').innerText = "Search Results";
            document.getElementById('tabBtn').innerText = "Back to Friends";

            if (results.length === 0) {
                container.innerHTML = '<p style="grid-column: span 2; text-align: center; color: #938F8F; padding: 2rem;">No users found.</p>';
                return;
            }

            // ÙŠØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡ ÙˆØ§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ù…Ø¹Ù„Ù‚Ø© ÙÙŠ loadAllData()
            const myFriendIds = friends.map(f => f.id);
            const pendingRequestUserIds = friendRequests.map(r => r.id); 

            container.innerHTML = results.map(user => {
                let buttonHtml = '';
                const isFriend = user.status === 'friends';
                const isSentByMe = user.status === 'sent_by_me';
                const isSentToMe = user.status === 'sent_to_me';

                if (isFriend) {
                    buttonHtml = '<button class="sent-btn" disabled>Already Friends</button>';
                } else if (isSentByMe) {
                    buttonHtml = '<button class="sent-btn" disabled>Request Sent</button>';
                } else if (isSentToMe) {
                    buttonHtml = '<button class="sent-btn" disabled>Request Received</button>';
                } else {
                    // ğŸŸ¢ [ØªØµØ­ÙŠØ­]: Ù†Ù…Ø±Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Username)
                    buttonHtml = `<button class="add-btn-small" onclick="sendFriendRequest(this, '${user.username}')">Add Friend</button>`;
                }

                return `
                    <div class="friend-card">
                        <div class="friend-header">
                            <div class="friend-avatar" style="background: #a0aec0;"></div>
                            <h3 class="friend-name">${user.username}</h3>
                        </div>
                        <div class="friend-footer">
                            <div class="friend-points">
                                <span class="points-text" style="font-size: 0.9rem; color: #666;">User Points: ${user.points || 0}</span>
                            </div>
                            ${buttonHtml}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRequests() {
            const container = document.getElementById('requestsContainer');
            if (friendRequests.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #777;">No new requests.</p>';
                return;
            }
            container.innerHTML = friendRequests.map(req => {
                // ğŸš¨ [Ù…Ù„Ø§Ø­Ø¸Ø©]: Ù‡Ù†Ø§ Ù†Ø¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ÙˆØ¬ÙˆØ¯ sender_id (Ø§Ù„Ù…Ø±Ø³Ù„) Ùˆ request_id (Ø±Ù‚Ù… Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©) ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨Ø§Øª
                
                return `
                    <div class="request-item">
                        <span class="request-name">${req.name || req.sender_username}</span>
                        <div class="request-actions">
                            <button class="action-btn accept-btn" onclick="acceptRequest(${req.sender_id})">
                                <div class="action-circle accept-circle"></div> Accept
                            </button>
                            <button class="action-btn decline-btn" onclick="declineRequest(${req.request_id})">
                                <div class="action-circle decline-circle"></div> Decline
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- 4. Logic Functions (Now Asynchronous) ---

        /**
         * ğŸŸ¢ [Ø§Ù„ØªØ¹Ø¯ÙŠÙ„]: Ø¯Ø§Ù„Ø© Ø¬Ù„Ø¨ Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ø¨Ø­Ø« Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…
         * ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ø±Ø· Ù„ÙŠÙ‚Ø¨Ù„ Ø­Ø±ÙØ§Ù‹ ÙˆØ§Ø­Ø¯Ø§Ù‹ (Ø£Ùˆ Ø£ÙƒØ«Ø±)
         */
        async function fetchAndRenderSearchResults(query) {
            
            // ğŸš¨ [Ø§Ù„ØªØ¹Ø¯ÙŠÙ„]: Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§Ø±ØºØ§Ù‹ (Ø£Ù‚Ù„ Ù…Ù† Ø­Ø±Ù)ØŒ Ù†Ø¹ÙˆØ¯ Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ØµØ¯Ù‚Ø§Ø¡
            if (query.length === 0) {
                renderFriends();
                return;
            }
            
            // ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù…Ø¹ ÙˆØ¬ÙˆØ¯ Ø­Ø±Ù ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„
            const fetchedResults = await fetchData(`/friends/users/search?q=${encodeURIComponent(query)}`);

            if (fetchedResults) {
                renderSearchResults(fetchedResults.map(user => ({
                    id: user.id,
                    username: user.username, 
                    points: user./study/points || 0,
                    status: user.status
                })));
            } else {
                renderSearchResults([]);
            }
        }


        // ğŸŸ¢ [Ø§Ù„ØªØ¹Ø¯ÙŠÙ„]: Ù…Ø¹Ø§Ù„Ø¬ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ø¬Ø¯ÙŠØ¯:
        document.getElementById('searchInput').addEventListener('input', function (e) {
            const query = e.target.value.trim();
            fetchAndRenderSearchResults(query);
        });

        // Tab click to reset search (ÙƒÙ…Ø§ Ù‡Ùˆ)
        document.getElementById('tabBtn').addEventListener('click', function () {
            document.getElementById('searchInput').value = "";
            renderFriends();
        });


        /**
         * Sends a friend request to a user.
         * @param {HTMLElement} btn - The button element clicked.
         * @param {string} targetUsername - The username of the user to send the request to.
         */
        async function sendFriendRequest(btn, targetUsername) {
            // 1. Disable button and show loading/pending state immediately for better UX
            const originalText = btn.innerText;
            btn.innerText = "Sending...";
            btn.disabled = true;

            // 2. Call the API
            // ğŸŸ¢ [ØªØµØ­ÙŠØ­]: Ù†Ø±Ø³Ù„ 'friend_username' ÙƒÙ…Ø§ ÙŠØªÙˆÙ‚Ø¹Ù‡ Ø§Ù„Ø¨Ø§Ùƒ Ø¥Ù†Ø¯
            const success = await sendMutation('/friends/request', 'POST', { friend_username: targetUsername });

            // 3. Handle the result
            if (success) {
                btn.innerText = "Request Sent";
                btn.className = "sent-btn";
                // Ù†ÙØ¹ÙŠØ¯ ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø­Ø« ÙˆØ·Ù„Ø¨Ø§Øª Ø§Ù„ØµØ¯Ø§Ù‚Ø©
                await loadAllData();
            } else {
                // Revert button state on failure
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }


        /**
         * Accepts a friend request.
         * @param {number} senderId - The ID of the user who sent the request.
         */
        async function acceptRequest(senderId) {
            // 1. Optimistic UI update (optional, but faster feeling)
            const originalRequest = friendRequests.find(r => r.sender_id === senderId);
            friendRequests = friendRequests.filter(r => r.sender_id !== senderId);
            renderRequests(); 

            // 2. Call the API
            // ğŸŸ¢ [ØªØµØ­ÙŠØ­]: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ù€ Body Ø§Ù„ØµØ­ÙŠØ­ÙŠÙ† (ÙŠØªÙˆÙ‚Ø¹ sender_id)
            const success = await sendMutation('/friends/accept', 'PUT', { sender_id: senderId });

            // 3. Handle the result
            if (success) {
                await loadAllData();
            } else {
                // Revert UI update and show an error
                if (originalRequest) friendRequests.push(originalRequest);
                renderRequests();
            }
        }

        /**
         * Declines a friend request.
         * @param {number} requestId - The ID of the relationship record to delete.
         */
        async function declineRequest(requestId) {
            if (confirm("Reject this friend request?")) {
                const originalRequest = friendRequests.find(r => r.request_id === requestId);
                friendRequests = friendRequests.filter(r => r.request_id !== requestId);
                renderRequests(); 

                // 2. Call the API
                // ğŸŸ¢ [ØªØµØ­ÙŠØ­]: Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø­Ø°Ù: /friends/:requestId (ÙŠØ¬Ø¨ Ø£Ù† ÙŠÙƒÙˆÙ† ID Ø§Ù„Ø¹Ù„Ø§Ù‚Ø©)
                const success = await sendMutation(`/friends/${requestId}`, 'DELETE');

                if (!success) {
                    if (originalRequest) friendRequests.push(originalRequest);
                    renderRequests();
                }
                // Ø¥Ø°Ø§ Ù†Ø¬Ø­ØŒ ÙØ¥Ù† loadAllData() Ø³ØªÙ‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ«
            }
        }

        /**
         * Removes a friend.
         * @param {number} otherUserId - The ID of the friend (the other user's ID).
         */
        async function removeFriend(otherUserId) {
            if (confirm("Remove this friend permanently?")) {
                // 1. Optimistic UI update
                const originalFriend = friends.find(f => f.id === otherUserId);
                friends = friends.filter(f => f.id !== otherUserId);
                renderFriends();

                // 2. Call the API
                // ğŸŸ¢ [ØªØµØ­ÙŠØ­]: Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„ØµØ­ÙŠØ­ Ù„Ù„Ø­Ø°Ù: /friends/:otherUserId (ÙŠØªÙˆÙ‚Ø¹ ID Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¢Ø®Ø±)
                const success = await sendMutation(`/friends/${otherUserId}`, 'DELETE');

                // 3. Handle the result
                if (success) {
                    await loadAllData();
                } else {
                    // Revert UI update and show an error
                    if (originalFriend) friends.push(originalFriend);
                    renderFriends();
                }
            }
        }

        // --- 5. Initial Run ---
        window.addEventListener('load', loadAllData);

    </script>
</body>

</html>


